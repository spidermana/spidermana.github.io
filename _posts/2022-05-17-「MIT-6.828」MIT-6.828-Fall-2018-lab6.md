---
layout: post
title: "「MIT 6.828」MIT 6.828 Fall 2018 lab6"
subtitle: " Lab6 终于到最后一个part了"
date:        2022-05-17 21:06:00
author:  "许大仙"
catalog: true
tags:
    - 系统
---

最近的科研告一段落了，实话实话，不太有多少成绩，完全算不是满意，不过过程还是比较快乐的。

马上要去实习了，所以把脱了这么久的OS lab做完吧。

然后再啃啃ULK和《Linux内核设计与实现》吧。

# Lab 6: Network Driver (default final project)

这是最后一个独立完成的lab了。

OS不能没有network stack【no self respecting OS should go without a network stack】，在这个实验中，我们要写一个E1000网卡的驱动。

>The card will be based on the Intel 82540EM chip, also known as the E1000.

Commit lab5中实现的内容，merge lab5到lab6 分支，并开始实验吧。

网卡驱动程序不足以让您的操作系统连接到 Internet。因此，在lab6 ，我们于新的 `net/`目录以及`kern/`中的新文件中为您提供了网络栈和网络服务器（a network stack and a network server）的code。

除了编写驱动程序之外，您还需要创建一个系统调用接口来访问您的驱动程序。您将实现missing的部分网络服务器代码以在network stack和driver之间传输数据包。您还将通过完成一个web服务器将所有内容联系在一起。使用自实现的Web服务器，您将能够从lab5中的文件系统内通过网络提取文件。

许多内核设备驱动程序代码几乎需要自己从头开始编写，并且这个实验提供的指导比以前的实验少得多：没有框架文件，没有一成不变的系统调用接口，许多设计决策都由您决定。出于这个原因，建议您在开始任何单独的练习之前阅读整个lab的描述。

## QEMU's virtual network

我们将使用 QEMU 的user mode下的network stack，因为它不需要管理权限即可运行。关于QEMU user-net的[信息文档在这里](http://wiki.qemu.org/download/qemu-doc.html#Using-the-user-mode-network-stack)。我们更新了 makefile 以启用 QEMU user-mode network stack和E1000 虚拟网卡。

默认情况下，QEMU 提供了一个运行在 IP 10.0.2.2 上的虚拟路由器，并将分配给 JOS 的 IP 地址为 10.0.2.15。为了简单起见，我们将这些默认值硬编码到`net/ns.h`中的network server内。

通过使用`-net user` 选项（即默认配置 ），QEMU将完全使用user-mode network stack。具体的虚拟网络配置如下：

```
guest (10.0.2.15)  <------>  Firewall/DHCP server <-----> Internet
                      |          (10.0.2.2)
                      |
                      ---->  DNS server (10.0.2.3)
                      |
                      ---->  SMB server (10.0.2.4)
```

The QEMU VM behaves as if it was behind a firewall which blocks all incoming connections.

虽然 QEMU's virtual network 允许 JOS 与 Internet 建立任意连接，但 JOS 的 10.0.2.15 地址在 QEMU 内部运行的虚拟网络之外没有任何意义（即 QEMU 充当 NAT），因此我们不能直接从外部甚至是host，连接到在JOS中运行的network server。为了解决这个问题，我们将 QEMU 配置为在主机的某个端口上运行一个服务器，该服务器简单地连接到 JOS 中的某个端口，并在您的真实主机和虚拟网络之间来回传输数据。【根据上述提到的QEMU文档，我们得知这种从host某个端口到QEMU guest的重定向可以通过`-netdev user,hostfwd=...`来实现】

我们将在端口 7 (echo) 和 80 (http) 上运行 JOS servers。为避免共享 Athena 机器【和课程相关】上的冲突，makefile 会根据您的用户 ID 生成转发端口。要找出 QEMU 在您的开发主机上转发到哪些端口，请运行`make which-ports`。为方便起见，makefile 还提供了`make nc-7`和`make nc-80`，它允许您直接与在终端的这些端口上运行的服务器进行交互。（这仅用于连接到正在运行的 QEMU 实例，您必须提前单独启动 QEMU。）

### Packet Inspection

makefile 还配置 QEMU 的network stack以将所有传入和传出的数据包记录到/lab目录中的`qemu.pcap`。

要获取捕获数据包的十六进制/ASCII 转储，请使用`tcpdump`，如下所示：

```
tcpdump -XXnr qemu.pcap
```

同时您可以使用Wireshark以图形方式检查 pcap 文，Wireshark可支持解码和检查数百种网络协议。

### Debugging the E1000

我们很幸运能够使用硬件仿真。Since the E1000 is running in software, 因此仿真的E1000可以以用户能够读懂的方式将内部状态和遇到的任何bug报告给我们。通常，对于使用裸机编写的驱动程序开发人员来说，这是几乎不可得的。

E1000 可以产生大量调试输出，为此您必须启用特定的日志记录通道（logging channels）。Some channels you might find useful are:

<img src="E:\github_repository\spidermana.github.io\img\assets\img\image-20220517220028916.png" alt="image-20220517220028916" style="zoom:50%;" />

例如，要启用“tx”和“txerr”日志记录，请使用`make E1000_DEBUG=tx,txerr ....`

> 注意： `E1000_DEBUG`标志仅适用于 6.828 版本的 QEMU。

You can take debugging using software emulated hardware one step further。也就是说，如果您遇到困难并且不明白为什么 E1000 没有按照您期望的方式运作，您可以在`hw/net/e1000.c`中查看 QEMU 的 E1000 实现。

## The Network Server





