---
layout: post
title: "「SQL注入入门篇」SQL注入（七）"
subtitle:   "为什么我是web安全菜鸡啊！！！"
date: 2016-10-26 12:00:00
author:     "许大仙"
tags:
    - web安全
---

<h2>Less-5(又乱了 此坑待填)</h2>
第五课到了报错注入和双注入，于是又折腾了好几天，花了很长时间理解原理和构造语句，仔细总结下吧。

<h3>形式</h3>
观察发现，在无错情况下只会显示“You are in...”，而在加单引号报错情况下才会显示一些信息。因此我们应该构造一个语句让他报错，在报错信息中把我们需要的其他信息带出来

<h3>知识点</h3>
<ul>
    <li>子查询</li>
    <li>Group by函数</li>
    <li>聚合函数</li>
    <li>rand()和floor()</li>
    <li>concat()</li>
</ul>

子查询：Select concat((<strong>select database()</strong>)); 这种形式就是多重查询，其中加粗部分会被优先执行，并将其结果返回给外层

Group by：

<h2>Less-7</h2>
第七课是通过outfile函数来下载数据库到外部文件，我们可以通过访问这个文件获取数据库中的信息，甚至可以通过与一些其他命令的结合来获取系统的密码文件等信息。

<h3>初步判断</h3>
正确的页面是"You are in...Use outfile"

<img src="http://oc42vgpoj.bkt.clouddn.com/less7_basic.png" />

报错的页面是"You have an error in your SQL syntax..."

<img src="http://oc42vgpoj.bkt.clouddn.com/less7_error.png" />

通过order by语句来先探查字段数目

<img src="http://oc42vgpoj.bkt.clouddn.com/less7_number.png" />

判断闭合方法（神特么能猜到==我还是太年轻）

<img src="http://oc42vgpoj.bkt.clouddn.com/less7_back2normal.png" />

<h3>条件</h3>
如果要正确的写入，需要以下几个条件：

<ul>
    <li>需要知道系统网站的默认路径，如果缺少了这个信息我们就看不到导出的文件</li>
    <li>需要知道字段数目，否则就不能正确的生成和到处文件</li>
    <li>需要注意路径名要用绝对路径，比如"/opt/lampp/htdocs/sqli/test.txt"，之前前面没有加斜杠被坑了很久</li>
    <li>可能还存在权限问题，比如某文件夹没有写入权限。这时候可以考虑下/tmp文件夹，这个由于是存放临时文件，一般都有写入权限，不过好像没啥用哈</li>
</ul>

一些常见网站配置的默认路径（从老大那里转载的）：

<ul>
    <li>WindowsServer IIS：c://inetpub/wwwroot/(asp)</li>
    <li>Linux Nginx：
<ul>
    <li>/usr/local/nginx/html</li>
    <li>/home/wwwroot/default</li>
    <li>/usr/share/nginx</li>
    <li>/var/www/html</li>
</ul>
</li>
    <li>Linux Apache：
<ul>
    <li>/var/www/htm</li>
    <li>/var/www/html/htdocs</li>
</ul>
</li>
    <li>Linux Xampp集成：/opt/lampp/htdocs/</li>
</ul>

<h3>写入语句</h3>
<pre class="lang:tsql decode:true" title="Payload">http://192.168.15.137/sqli/Less-7/?id=1')) union select 1,2,3 into outfile "
/opt/lampp/htdocs/sqli/Less-7/eee.txt" --+</pre>

<img src="http://oc42vgpoj.bkt.clouddn.com/less7_outfile.png" />

<img src="http://oc42vgpoj.bkt.clouddn.com/less7_result.png" />

<img src="http://oc42vgpoj.bkt.clouddn.com/less7_read.png" />

我们也可以通过load_file()函数来调用载入外部文件，例如可以去调用"/etc/passwd"文件，把他导出

<pre class="lang:default decode:true" title="Passwd">http://192.168.15.137/sqli/Less-7/?id=1'))  union select 1,2,load_file("/etc/passwd") into outfile 
"/opt/lampp/htdocs/sqli/Less-7/hehe.txt" --+
</pre>

玩法有很多，自己开发。

<h2>Less-8</h2>
基于布尔值的盲注

<h3>Length()</h3>
用于输出所选内容的长度，例如<code>select length("hahaha")</code>显示结果为6

<h3>Substr()</h3>
substr(str, pos, len) 该函数用于截断字符串，第一个参数是所需切分的字符串，第二个选项是起点，第三个选项是步长。需要注意的是，pos是从1开始的。例如<code>select substr("hello"),1,2</code>显示结果应该是"he"

<h3>Ascii()</h3>
ascii(str) 该函数接受字符，并将其转化为ASCII码，这样能方便我们用二分法更快的查找正确的字符对应的ASCII码，这样就能获取到字符的信息

<h3>特征</h3>
可以看到我们正常访问时有提示"You are in..."，但如果报错的话就没有回显。我们能得到的信息只有布尔值，因此称之为基于布尔值的注入。

<h3>Payload</h3>
<pre class="lang:tsql decode:true" title="Payload">?id' and (select ascii(substr(database(),1,1)) &gt; 100)--+ //true
?id' and (select ascii(substr(database(),1,1)) &lt; 150)--+ //true
?id' and (select ascii(substr(database(),1,1)) &gt; 125)--+ //false
?id' and (select ascii(substr(database(),1,1)) &gt; 112)--+ //true
?id' and (select ascii(substr(database(),1,1)) &gt; 118)--+ //false
?id' and (select ascii(substr(database(),1,1)) = 115)--+ //true</pre>

二分法查找，同理可猜测其他字符

<strong>脚本自动化盲注</strong>

<h2>Less-9&amp;Less-10</h2>
单引号型基于时间的盲注，或双引号（逃

<h3>Sleep()</h3>
sleep(int) 该函数接受一个整数作为参数，运行成功后会将整个程序挂起若干秒。因此我们可以在无回显时用这个来作为payload是否执行的标志。

<h3>If()</h3>
if(expr1, expr2, expr3) 该函数接受三个参数，当expr1为真时，返回expr2，否则返回expr3的结果。

<h3>判断闭合情况</h3>
<pre class="lang:tsql decode:true " title="Determin">id=1 and sleep(10) +--+
id=1' and sleep(10) +--+
id=1') and sleep(10) +--+
id=1" and sleep(10) +--+
id=1") and sleep(10) +--+</pre>

<h3>Payload</h3>
<pre class="lang:default decode:true " title="Payload">id=1' and (select if(ascii(substr((select table_name from information_schema.tables 
where table_schema=database() limit 0,1),1,1))=111,sleep(10),NULL))--+</pre>

<hr />
系统崩了，重装前忘了备份这个文件...

于是大半夜重写了一遍啊啊啊啊啊

嗯，受某人影响还是觉得应该改改自己的性格。做一件事就做到最好。

&nbsp;