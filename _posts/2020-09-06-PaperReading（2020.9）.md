---
layout: post
title: PaperReading(2020.9)
date: 2020-09-06 09:58:00
author:     "许大仙"
catalog: true
tags:
    - Paper
---

## Scarecrow: Deactivating Evasive Malware via Its Own Evasive Logic

### 1. Abstract

- Background：很多恶意软件会在进行恶意行为之前，使用一些逃避策略（embedded evasive logic）来检测执行环境是否是sandbox等恶意软件动态分析环境（ dynamic malware analysis environments）。如果是，那么就不执行/隐藏这些恶意行为（从而使得这些基于恶意行为的动态分析框架无效了），甚至执行一些针对框架的破坏。

- Insight：采用逃避策略来规避动态恶意代码分析其实是一把双刃剑。在避免被分析的同时，限制了恶意软件激活的执行环境范围（意味着malware激活后的活动范围是有限的，造成的破坏也是有限的，而且往往直接退出或只执行良性行为）。

  - 博弈与对立：Evasive techniques have a limited applicable scope and malware authors typically enhance the evasive logic by adding more new checks while keeping existing checks to be backward compatible【恶意代码越加强环境检测能力，这个工具越有效】
  - Ad.： By satisfying a small subset of conditions, we successfully deactivated a large number of evasive malware samples. 

- Solution：利用这种对立的窘境，开发了SCARECROW——将终端用户的执行环境伪装成为动态分析环境（camouﬂaging end-user execution environments into analysis-like environment），相应地malware的执行环境范围和造成的破环程度都会有所下降。
  - inline Hook and DLL named scarecrow.dll injection（by [EasyHook](https://easyhook.github.io/)）
    - API：Software resources 、Hardware resources 、Network resources 
      1. Files and Folders
      2. Processes
      3.  Libraries
      4. GUI windows
      5. Registries
      6.  Function Hooks
      7. Exception processing（有些调试器或动态分析环境会利用exception handler来进行分析，从而出现异常处理的时间差异等副作用）
         - SCARECROW introduces deceptive timing discrepancies in default exception processing with minimal to no impact on benign applications. 
      8. Extended：support “aging”-related deceptive resources.
    
  - Deployment Framework 
  
    - The framework consists of SCARECROW controller (scarecrow.exe) and SCARECROW library (scarecrow.dll). 
    - SCARECROW controller starts executing the target program and injects scarecrow.dll into the target process. 
    - The DLL **installs the API hooks and exchanges runtime information** between the target process and the controller. 
    - Speciﬁcally, scarecrow.dll communicates with scarecrow.exe through interprocess communication (IPC) channels when a deceptive execution environment is ﬁngerprinted by evasive malware. SCARECROW controller dynamically **updates the hooks and conﬁgurations through IPC**. 
  
    ![稻草人](/img/paper/scarecrow1.png)
  
- Experiment： 
  - successfully deactivate 89.56% of evasive malware samples and the variants of ransomware (e.g., WannaCry and Locky) 

  - 同时，对良性的普通软件的运行几乎没有影响

  - SCARECROW可以使得end-user execution environments with SCARECROW和malware analysis environments with SCARECROW不易区分。

  -  Data Sources：
    - Joe Security (MJS): Joe Security released its detailed analysis reports of 18 evasive malware samples 
    - MalGene (MMG): We obtained 1,054 evasive malware samples from the authors of MalGene[25].
    - CNET Software (BCNET):  the top 20 most popular Windows programs from CNET.
    
    ![稻草人](/img/paper/scarecrow2.png)
    
    ![稻草人](/img/paper/scarecrow3.png)

  - 使用了两种 state-of-the-art analysis environment ﬁngerprinting techniques: Paﬁsh [2] (also known as Paranoid Fish) and wear-and-tear artifacts-based evasion，证明了这些罗列的逃避技术执行能检测出SCARECROW的存在【误认为在虚拟环境中】

    ![稻草人](/img/paper/scarecrow4.png)

    -  Extended with deceptive wear-and-tear resources：SCARECROW was able to steer the values of those top 5 artifacts plus the artifacts from the largest registry category, which would largely affect the analysis environment ﬁngerprinting decisions.【消减人为操作以被判断为虚拟静态的环境——eg：sandbox】

    ![稻草人](/img/paper/scarecrow5.png)

  - Logic proof：

    - Essentially its evasive logic was a logical disjunction D of multiple propositions pi, i.e., D = p1∨p2∨...∨pi.
    - Negate the logical disjunction D, i.e., ¬D = ¬(p1 ∨p2 ∨...∨pi)=¬p1 ∧¬p2 ∧...∧¬pi, which indicates that we **only need one pi to be True to deactivate evasive malware in end-user environments**
    -  one of the major advantages of SCARECROW is that **<u>we do not need to handle all evasive logic</u>**. 

  - SCARECROW deactivated two well-known ransomware: WannaCry and Locky

    - only manipulate the resolution of non-existent domains【a DNS sinkhole to resolve nonexistent domains into controlled IP addresses】
    - has no impact on the behavior of benign software, which does not rely on connecting to non-existent domains

- Critical thinking：
  - 造成伪装一定要消耗额外的计算机资源（伪造一个名为VMwareUser.exe的进程）【已解决】
    - 不直接伪造资源，而通过hook API，来修改返回值达到欺骗的目的
    - 同时stop those samples with self-spawning（不断新建进程以逃避debugger） loop behavior
  - 只对应用层进行deception，没有在硬件/指令层面进行deception
    - eg：RDTSC指令【timing channels to detect the analysis environment】
    - Some of the missed features were related to CPU timing information (e.g., rdtsc_diff_vmexit and rdtsc_diff),
      which was not handled by the current implementation of SCARECROW. 
    - However, as we observed before, such timing attacks are not reliable methods for evasive malware to detect analysis environments. Some missed features were not supported due to the unsupported system versions. For example, IsNativeVhdBoot was only supported in Windows 8 while Windows 7 was used for our evaluation.
      -  However, cpuid_hv_bit and cpu_known_vm_vendors are not reliable evidence since they can be easily manipulated. Both VMware and VirtualBox allow modifying the CPUID instruction results to generate customized outputs for the CPUID instruction to the guest
  -  执行一些针对框架的破坏如何解决？

### 2. 扩展参考：

#####  analysis environment ﬁngerprinting techniques

- https://github.com/a0rtega/pafish
  - Pafish is a demonstration tool that employs several techniques to detect sandboxes and analysis environments in the same way as malware families do. And you can read the code of all anti-analysis checks. 
- [Spotless Sandboxes](https://www.ieee-security.org/TC/SP2017/papers/429.pdf)

##### Anti-VM指令

- CPUID指令获取CPU信息，来判断环境是否是虚拟的：https://consen.github.io/2016/09/11/Anti-VM-via-CPUID/
  - `CPUID`指令用来获取CPU信息，将功能号作为参数传入`EAX`寄存器，CPUID将信息返回到`EAX、EBX、ECX、EDX`寄存器。下面是两个检测虚拟环境的功能号：
    - EAX = 1，获取CPU功能信息，如果ECX第31位为1， 则表明有hypervisor存在，即环境是虚拟的。
    - EAX = 0x40000000, 获取hypervisor信息，返回12字节长度字符串
- RDTSC指令从时间角度判断环境是否是虚拟的：https://consen.github.io/2016/09/12/Anti-VM-via-RDTSC/
  - The Time Stamp Counter (TSC) is a 64-bit register present on all x86 processors since the Pentium. It counts the number of cycles since reset. The instruction RDTSC returns the TSC in EDX:EAX. In x86-64 mode, RDTSC also clears the higher 32 bits of RAX and RDX. Its opcode is 0F 31.
-  Both VMware and VirtualBox allow modifying the CPUID instruction results to generate customized outputs for the CPUID instruction to the guest. 



### :star:词汇积累

- unforeseen malicious activities
  - **unforeseen**：not expected to happen or known about beforehand. 未预见的.
- a double-edged sword（双刃剑）
-  constrains the spectrum of execution environments 
  -  **spectrum**：a range of a particular type of thing. 范围.
  - 光谱
- exploit this dilemma（利用这种窘境）
- reverse the challenge（克服/逆转挑战）
  - 使 (决定、政策、趋势) 转向; 逆转、调换 (位置、功能)；背面、反面；朝相反方向;
  - the  reverse side、in reverse

- camouflage（(军事) 伪装、(某些动物的) 保护色; 伪装手段、掩饰）
  - He has never camouflaged his desire to better himself.
- **steer** state-of-the-art analysis techniques 

