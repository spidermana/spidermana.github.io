---
layout:	post
title:		"Malware Analysis and CVE Recurrence"
subtitle:	"坚持就是胜利！"
date:	2020-11-05 11:12:00
author:		"许大仙"
catalog:	true
tags:
	- Malware
---

本文不定期更新，分析新旧恶意软件和CVE。

### Meltdown and Spectre

Meltdown对应CVE-2017-5754（乱序执行缓存污染），Spectre对应CVE-2017-5753（边界检查绕过）与CVE-2017-5715（分支目标注入）

Meltdown漏洞影响几乎所有的Intel CPU和部分ARM CPU，而Spectre则影响所有的Intel CPU和AMD CPU，以及主流的ARM CPU。

**<u>背景：预测执行+乱序执行</u>**

- https://zhuanlan.zhihu.com/p/22469702【结尾的双模态预测器(bimodal predictor)】
- https://www.zhihu.com/question/23973128【**2 Level Adaptive Training**】
- https://www.jianshu.com/p/be389eeba589【动态预测器与BTB（Branch Target Buffer）】

> 了解如何如何分支预测自动机的原理，是如何训练的，如何基于历史进行预测的

**<u>漏洞基本原理</u>**

- https://zhuanlan.zhihu.com/p/32757727
- https://www.freebuf.com/articles/system/159811.html【POC分析】

**<u>POC</u>**

- https://github.com/paboldin/meltdown-exploit
- 注释代码：
  - [meltdown.c](https://github.com/spidermana/spidermana.github.io/blob/master/files/meltdown.c)
  - [detect_rdtscp.sh](https://github.com/spidermana/spidermana.github.io/blob/master/files/detect_rdtscp.sh)

**<u>实战</u>**

- https://xuanxuanblingbling.github.io/ctf/pwn/2020/06/30/meltdown/

**<u>论文</u>**

- [Meltdown: Reading Kernel Memory from User Space](https://meltdownattack.com/meltdown.pdf)
- [Spectre Attacks: Exploiting Speculative Execution](https://spectreattack.com/spectre.pdf)【由于CPU性能问题，该漏洞到2020年仍然有多种CPU未修复】

**<u>额外学习点：</u>**

- “无序”遍历，避免cache预先读取相邻块【避免局部性原理】
 ```c
for (i = 0; i < VARIANTS_READ; i++) {
  		mix_i = ((i * 167) + 13) & 255; //硬编码了 167 和 13 进去，其实就是两个质数，目的就是让 cache 预读摸不着头脑，不会因为线性预读取干扰了测时。
  		//如果读取是非线性的，那么cache不会进行相邻块预读取操作，就不会影响测时
  		//同样是遍历0~255，通过i遍历可能会到cache预读取
  		//而通过mix_i = ((i * 167) + 13) & 255来遍历，不会造成cache预读取，同时还可以保证“无序”遍历0~255
    //遍历过程中mix_i不会重复，且覆盖0~255完整区间
 ```

- 基于时间的cache旁道攻击方法

### Mirai

源码及复现：

- https://github.com/ruCyberPoison/-Mirai-Iot-BotNet
- https://github.com/jgamblin/Mirai-Source-Code

源码分析：

- https://paper.seebug.org/142/